# Utilities Layer (`app/utils/`)

このディレクトリは、アプリケーションの各所で使用される **汎用的なヘルパー関数** や **デコレータ** を集約しています。
特定のビジネスロジック（Service層）にも、Webルーティング（Router層）にも属さない、共通の道具箱として機能します。

## 📁 内部ファイルの役割

### `decorators.py` (アクセス制御と認証)
Flaskのルーティング関数（View）に付与することで、セキュリティやアクセス権限のチェックを宣言的に行うためのカスタムデコレータを定義しています。

* **`@role_required(*roles)`**:
    * 指定されたロール（役割）を持つユーザーだけがアクセスできるように制限します。
    * 例: `@role_required("admin")` と記述すると、管理者以外のアクセスを403 Forbiddenで拒否します。
* **`@check_patient_assignment`**:
    * URLパラメータに含まれる `patient_id` を読み取り、**「ログイン中の職員がその患者の担当であるか」** を検証します。
    * 管理者 (`admin`) は無条件でアクセス可能ですが、一般職員 (`general`) は担当外の患者データへのアクセスをブロックされます。これにより、URL直打ちによる不正アクセスを防ぎます。

### `helpers.py` (汎用ヘルパー)
データの整形や日付操作など、特定のドメインに依存しない純粋な関数群です。

* **主な機能（例）**:
    * 日付文字列のフォーマット変換
    * エラーメッセージの共通整形処理
    * その他、テンプレートやサービスから呼び出される便利関数

## 🔗 関係性

* **⬅️ Used by `app/routers/`**:
    * 全てのBlueprint（`admin`, `plan`, `patient`）で、ルート定義の直前にここのデコレータが使用されています。
* **➡️ Uses `flask_login`**:
    * `current_user` オブジェクトを通じて、現在ログインしているユーザーの情報を参照します。
* **➡️ Uses `app/crud/`**:
    * 担当割り当ての確認などのために、データベース参照を行う場合があります。

## 📝 設計のポイント

### AOP (アスペクト指向) 的なアプローチ
「権限チェック」や「担当者確認」といったロジックを各コントローラー関数の内部に `if` 文として書くのではなく、デコレータとして外出しすることで、**ビジネスロジックの可読性** を高め、**セキュリティポリシーの適用漏れ** を防ぐ設計としています。