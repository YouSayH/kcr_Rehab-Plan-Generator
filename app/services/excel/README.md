# Excel Generation Layer (`app/services/excel/`)

このディレクトリは、リハビリ計画書のデータを **Excelファイル (.xlsx)** として生成・出力する機能を提供します。

Pythonの `openpyxl` ライブラリを使用していますが、コード内でゼロからセルを構築するのではなく、あらかじめデザインされた **テンプレートファイル (`template.xlsx`)** を読み込み、必要な箇所にデータを流し込むアプローチを採用しています。これにより、複雑な帳票レイアウトを維持しながら、保守性の高いコードを実現しています。

## 🏗 アーキテクチャと設計思想

### 1. テンプレートエンジン方式
帳票のデザイン（罫線、フォント、ロゴ配置など）は、Excelファイルそのもの (`template.xlsx`) で管理します。
プログラム側は「どのセルにどの値を入れるか」だけに関心を持ち、デザインの調整はExcel上で行います。これにより、現場からの「文字を大きくしてほしい」「枠線を太くしてほしい」といった要望に、コード修正なしで対応可能です。

### 2. 設定とロジックの完全分離
「DBのカラム `name` は、Excelの `Sheet1` の `C5` セルに書く」といった対応関係（マッピング）は、全て **`mappings.py`** に集約しています。
**`writer.py`** には具体的なセル番地を一切記述せず、汎用的な書き込みロジックのみを実装しています。
これにより、Excelの行が増減してセル番地がズレた場合でも、`mappings.py` を修正するだけで対応完了します。

### 3. 特殊なセル操作の抽象化
Excel特有の扱いづらい要素（結合セル、チェックボックス表現、元号対応など）を処理するロジックをカプセル化し、呼び出し元からは単純なデータの書き込みに見えるようにしています。

---

## 📁 内部ファイル詳細

### `writer.py`
* **役割**: Excel生成の実行エンジン。
* **主なロジック**:
    * **`create_plan_sheet`**: メイン関数。テンプレートをロードし、以下のサブ関数を使ってデータを書き込み、ファイル保存（またはバイト列返却）を行います。
    * **`_get_cell_by_address`**: **結合セル (Merged Cells)** への書き込みに対応。結合された範囲の左上のセルを自動的に特定して値をセットする重要ロジックです。
    * **`_write_selection_fields`**: DB上の値（例: `"level_1"`）を、Excel上の特定のセルへのチェックマーク（`☑`）に変換します。

### `mappings.py`
* **役割**: データベースとExcelの対応定義ファイル（Configuration）。
* **定義内容**:
    * **`TEXT_MAPPING`**: 単純なテキスト転記（DBカラム名 ↔ シート名・セル番地）。
    * **`DATE_MAPPING`**: 日付データ（年・月・日）をバラバラのセルに分割して書き込む設定。
    * **`SELECTION_MAPPING`**: ラジオボタン等の選択肢と、チェックマークを入れるべきセルの対応表。
    * **`TEMPLATE_PATH`**: テンプレートファイルのパス（デフォルト: プロジェクトルートの `template.xlsx`）。

## 🔗 関係性

* **⬅️ Used by `app/services/plan_service.py`**:
    * 計画書保存ワークフローの中で呼び出され、DB保存直後にExcelファイルを生成します。
* **⬅️ Used by `app/routers/plan/views.py`**:
    * ユーザーが「Excelダウンロード」ボタンを押した際に呼び出され、バイナリデータをブラウザに返します。
* **Resources**:
    * **`template.xlsx`**: プロジェクトルートにあるExcelテンプレートファイルを参照します。

## 📝 開発者向けメモ

### Excelレイアウト変更時の対応手順
Excelテンプレートに行を挿入したり、レイアウトを変更した場合は、以下の手順で修正します。

1.  **テンプレート更新**: プロジェクトルートの `template.xlsx` を新しい様式に置き換える。
2.  **マッピング修正**: `app/services/excel/mappings.py` を開き、ズレた項目のセル番地（例: `"C5"` → `"C6"`）を修正する。
    * **`writer.py` の修正は不要です。**

### チェックマークの仕様
現在、チェックボックスがONの状態は `☑` (U+2611)、OFFの状態は `☐` (U+2610) という特殊文字で表現しています。フォント環境によっては文字化けする可能性があるため、その場合は `mappings.py` 内の定義文字を変更してください。