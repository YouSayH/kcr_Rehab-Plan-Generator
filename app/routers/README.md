# Routers / Controllers Layer (`app/routers/`)

このディレクトリは、MVCアーキテクチャにおける **Controller** として機能します。
Flaskの **Blueprint機能** を使用して、アプリケーションの機能を論理的な単位（認証、管理、患者、計画書）に分割して管理しています。

WebブラウザからのHTTPリクエストを受け取り、適切なビジネスロジック (`services`) を呼び出し、最終的なレスポンス（HTMLテンプレートのレンダリング または JSONデータ）を返却します。

## 🏗 アーキテクチャと設計思想

### 1. 機能単位のモジュール分割 (Modular Blueprints)
巨大な `app.py` に全てのルート定義を書くのではなく、機能ドメインごとにファイルを分割しています。
* **Auth**: ログイン・ログアウト
* **Admin**: 職員管理・権限設定
* **Patient**: 患者情報のCRUD
* **Plan**: リハビリ計画書の作成・閲覧（このアプリのコア機能）

### 2. ViewとAPIの分離 (Separation of Views and APIs)
特に複雑な「計画書作成機能 (`plan`)」においては、画面遷移を伴う処理と、画面内での動的な更新（JavaScriptによる非同期通信）を明確にファイルレベルで分離しています。
* **`views.py`**: 画面全体を構築し、HTMLを返すルート。GETリクエストや、フォーム送信後のリダイレクト処理を担当。
* **`api.py`**: JavaScript (`fetch`) から呼び出されるエンドポイント。JSONデータの返却や、**Server-Sent Events (SSE)** を用いたAI生成テキストのストリーミング配信を担当。

### 3. アクセス制御とセキュリティ (Security & Access Control)
* **`@login_required`**: ほぼ全てのエンドポイントでログインを必須としています。
* **`@role_required`**: 管理者 (`admin.py`) などの重要機能には、ロールベースのアクセス制御を適用しています。
* **担当患者チェック**: 計画書の閲覧・作成時には、ログイン中の職員がその患者の担当であるかをチェックするロジックを組み込んでいます（`admin`権限を除く）。

---

## 📁 モジュール詳細

### `auth.py` (認証)
* **Blueprint**: `auth_bp`
* **役割**: ユーザーのセッション管理。
* **主なルート**:
    * `/login`: ユーザー認証とセッション確立。
    * `/logout`: セッション破棄。
    * `/signup`: （初期導入用）新規ユーザー登録。

### `admin.py` (管理者機能)
* **Blueprint**: `admin_bp`
* **役割**: システム全体の管理。`admin` ロールを持つユーザーのみアクセス可能。
* **主なルート**:
    * `/admin/staff`: 職員アカウントの一覧表示、削除。
    * `/admin/assignments`: 職員と患者の担当割り当て（多対多リレーション）の管理画面。

### `patient.py` (患者管理)
* **Blueprint**: `patient_bp`
* **役割**: 患者基本情報の管理。
* **主なルート**:
    * `/patients/`: 患者一覧（担当患者のみ表示するフィルタリングロジックを含む）。
    * `/patients/register`: 新規患者登録。
    * `/patients/<id>/edit`: 患者情報の編集。

### `plan/` (計画書作成コア機能)
このアプリケーションの核心部分であり、ディレクトリとして独立させています。

#### `plan/__init__.py`
* `plan_bp` の定義と、配下の `views`, `api` の結合を行います。

#### `plan/views.py` (画面遷移)
* **役割**: ユーザーインターフェースの提供。
* **ロジック**:
    * **ウィザード形式**: 「患者選択」→「AI生成」→「確認・編集」→「完了」という一連のワークフローを制御します。
    * **Excelダウンロード**: 完成した計画書データを `services.excel` モジュールに渡し、生成されたファイルのダウンロードレスポンスを返します。

#### `plan/api.py` (非同期処理・AI連携)
* **役割**: フロントエンドのJavaScriptと連携するバックエンドAPI。
* **重要ロジック**:
    * **ストリーミング生成 (`/plan/generate/stream`)**:
        * 生成に時間がかかるLLMのレスポンスを、**Generator関数 (`yield`)** を用いて逐次フロントエンドに送信します。
        * これにより、ユーザーはAIが文字を打っている様子をリアルタイムに見ることができ、待機時間のストレスを軽減します。
    * **フィードバック収集 (`/plan/suggestion/like`)**:
        * ユーザーがAIの提案に「いいね」を押した際、非同期でデータベースに記録します。

## 🔗 依存関係

* **➡️ Calls `app/services/`**: ビジネスロジック（LLM呼び出し、Excel生成など）はサービス層に委譲します。
* **➡️ Calls `app/crud/`**: 単純なデータの取得や保存はCRUD層を直接呼ぶこともあります。
* **➡️ Renders `app/web/templates/`**: 処理結果をJinja2テンプレートに流し込み、HTMLを生成します。
* **⬅️ Used by `app/__init__.py`**: アプリ起動時にこれらのBlueprintが登録されます。