# Plan Management Module (`app/routers/plan/`)

このディレクトリは、アプリケーションのコア機能である **「リハビリテーション総合実施計画書」の作成・閲覧・管理** を担当するコントローラーモジュールです。

単一のファイルではなくパッケージとして構成されており、**「画面遷移（View）」** と **「非同期API」** を明確に分離することで、複雑な生成フローとリッチなUI操作を両立させています。

## 📁 内部ファイルの構成と役割

### 1. `__init__.py`
* **役割**: `plan_bp` (Blueprint) の定義と、サブモジュールの集約。
* **処理**: `views` と `api` をインポートすることで、それらに定義されたルートを一つのBlueprintとして統合し、アプリケーション本体に公開します。

### 2. `views.py` (画面遷移と同期処理)
ユーザーがブラウザで直接アクセスする「ページ」のレンダリングを担当します。

* **主な機能**:
    * **ウィザード形式のUI制御**: 計画書作成を「患者選択」→「AI生成」→「確認・編集」というステップに分け、セッションやPOSTリクエストを使って状態を引き継ぎながら画面を遷移させます。
    * **Excelダウンロード (`/download/<plan_id>`)**: `services/excel` モジュールと連携し、完成したデータをバイナリファイルとしてレスポンスします。
    * **履歴表示**: 患者ごとの過去の計画書一覧を表示します。
* **設計ポイント**:
    * **アクセス制御**: `check_patient_assignment` デコレータ等を使用し、担当外の患者の計画書を作成・閲覧できないようにガードしています。

### 3. `api.py` (非同期処理とAIストリーミング)
フロントエンドのJavaScript (`fetch` API) から呼び出されるバックエンドAPIエンドポイントです。画面遷移を伴わない動的な処理を担当します。

* **主な機能**:
    * **AI生成ストリーミング (`/generate/stream`)**:
        * **技術**: **Server-Sent Events (SSE)** の仕組み（またはチャンク転送）を利用し、LLMが生成したテキストをトークン単位でリアルタイムにブラウザに送信します。
        * **UXへの効果**: 生成完了まで数秒〜数十秒待たせるのではなく、文字が打たれる様子を即座に表示することで、ユーザーの体感待ち時間を劇的に短縮しています。
    * **いいね機能 (`/suggestion/like`)**:
        * ユーザーがAIの提案に対して「いいね」ボタンを押した際、非同期でDBへの保存 (`UPSERT`) を行います。
        * 画面のリロードなしでフィードバックを即座に記録します。

## 🏗 アーキテクチャとロジック

### 🔄 生成フローの設計 (Generation Workflow)

1.  **入力フェーズ (`views.py`)**:
    * ユーザーは「リハビリ実施記録」などのテキスト情報を入力フォームに貼り付けます。
2.  **解析フェーズ (`api.py` / `services`)**:
    * 非同期リクエストでテキストを送信し、`PatientInfoParser` (LLM) が構造化データ（ADLスコアやリスクなど）を抽出します。
3.  **生成フェーズ (`api.py`)**:
    * **Gemini** (クラウド) と **Ollama** (ローカル) の両方に対し、並列または順次でリクエストを投げることができます。
    * 生成された「全体方針」や「目標」はストリーミングで画面に流し込まれます。
4.  **保存フェーズ (`crud/plan.py`)**:
    * ユーザーが確認・修正した最終結果は、単なるテキストではなく、Excelのセル構造に対応した数百のカラムを持つレコードとしてデータベースに保存されます。

### 🧬 依存関係

このモジュールは、アプリケーション内の多くのサービスをオーケストレーション（指揮）する役割を持っています。

* **Uses `app/services/llm/`**: AI生成の実行（Gemini, Ollama, RAG）。
* **Uses `app/services/excel/`**: 画面データをExcelファイルに変換。
* **Uses `app/crud/`**: データベースへの読み書き。
* **Uses `app/models/`**: データ構造の定義。

## 📝 開発者向けメモ

* **JavaScriptとの連携**: `api.py` のレスポンス形式を変更する場合、対応するフロントエンドのJSファイル（`app/web/static/js/` 配下にある生成ロジック）も修正する必要があります。
* **タイムアウト対策**: AI生成は時間がかかるため、NginxやGunicornの設定でタイムアウト時間を十分に長く設定する必要があります（現在はストリーミングによりコネクションが維持されるため、比較的切れにくい設計にはなっています）。