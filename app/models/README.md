# Data Models Layer (`app/models/`)

このディレクトリは、アプリケーションの **データモデル（データベーススキーマ）** を定義しています。
SQLAlchemyの **ORM (Object-Relational Mapping)** 機能を使用し、データベースのテーブルをPythonのクラスとして操作できるように設計されています。

## 🏗 アーキテクチャと設計思想

### 1. 循環参照の回避 (`base.py`)
SQLAlchemyでは、異なるモデルファイル同士が `relationship` で相互に参照し合う（例: PatientがStaffを参照し、StaffがPatientを参照する）構成が頻繁に発生します。
これを単一のファイルや不適切な順序でインポートすると「循環参照エラー (Circular Import Error)」が発生します。
本プロジェクトでは、**`base.py` に `Declarative Base` の定義のみを分離** することで、どのモデルファイルからも安全に `Base` クラスを継承できるように設計しています。

### 2. 多対多のリレーションシップ (Many-to-Many)
`Patient`（患者）と `Staff`（担当職員）の関係は「多対多」です（一人の患者を複数の職員が担当し、一人の職員が複数の患者を担当する）。
これを実現するために、`staff.py` 内で中間テーブル `staff_patients_association` を定義し、`relationship(secondary=...)` を用いて、あたかも直接リストとしてアクセスできるような透過的なインターフェースを提供しています。

### 3. ドキュメント指向の巨大なテーブル設計
リハビリ計画書は数百のチェックボックスや記述欄を持つ複雑な帳票です。
NoSQL（JSON型）に逃げることなく、`RehabilitationPlan` モデルにてこれら全てのフィールドを個別のカラム（`Boolean`, `Text`, `Integer`）として厳密に定義しています。
これにより、将来的に「特定のチェックボックスがONの患者」や「ADLスコアの推移」などをSQLで高速に集計・分析することが可能になります。

---

## 📁 ファイル別詳細解説

### `base.py`
* **役割**: 全モデルの親となる基底クラス (`Base`) を生成します。
* **設計**: 他のモデル定義ファイルは必ずここから `Base` をインポートして継承します。

### `patient.py`
* **テーブル名**: `patients`
* **役割**: 患者の基本属性（ID、氏名、生年月日など）を管理します。
* **ロジック**:
    * **`@property def age(self)`**: データベースには「生年月日」のみを保存し、年齢はアクセスするたびに現在日付から動的に計算するプロパティとして実装しています。これにより、データの不整合（年齢の更新忘れ）を防ぎます。

### `staff.py`
* **テーブル名**: `staff`
* **役割**: アプリケーション利用者の認証情報と属性を管理します。
* **構成**:
    * `Staff` モデル: ユーザー名、ハッシュ化されたパスワード、職種などを保持。
    * `staff_patients_association`: 中間テーブルの実体定義。

### `plan.py`
* **役割**: リハビリ計画書本体と、AI生成機能に関連する付随データを管理します。
* **主要モデル**:
    * **`RehabilitationPlan`**: 計画書のデータを保持するメインテーブル。カラム名はExcelテンプレートの項目と対応しています（例: `header_therapy_pt_chk` = 理学療法のチェックボックス）。
    * **`SuggestionLike`**: AIの提案に対するユーザーの「いいね」アクションを記録します。複合主キーを使用し、同じ項目に対して複数のモデル（Gemini, Ollama等）を評価できるようにしています。
    * **`LikedItemDetail`**: 「いいね」された瞬間のAI生成テキスト、患者情報、セラピストのメモをスナップショットとして保存します。これは将来、**AIモデルのファインチューニング（再学習）用データセット** として活用することを意図した設計です。
    * **`RegenerationHistory`**: どの項目が何度再生成されたかを記録し、AIの品質評価に役立てます。

## 🔗 関係性 (Relationships)

各モデルは以下のように相互接続されています：

* **Patient** `1` <---> `N` **RehabilitationPlan**
* **Patient** `N` <---> `M` **Staff** (担当割り当て)
* **SuggestionLike** は **Patient** および **Staff** と紐づき、誰がどの患者のどの項目を評価したかを追跡します。

## 📝 開発者向けメモ

新しいカラムを追加する場合は、モデル定義を変更した後、データベースのマイグレーション（カラム追加のALTER文発行）が必要です。現在は `schema.sql` で初期化を行っていますが、稼働中のDBに対する変更は注意して行ってください。