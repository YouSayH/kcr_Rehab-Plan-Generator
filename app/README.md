# Application Root (`app/`)

このディレクトリは、Flaskアプリケーションの **本体（ルートパッケージ）** です。
アプリケーションの初期化、設定の読み込み、および各機能モジュール（Blueprint）の登録を行い、Webサーバーとして起動可能な状態にします。

## 📁 内部ファイルの役割

### `__init__.py` (アプリケーションファクトリ)
Flaskアプリケーションの **エントリポイント** です。

* **`create_app()` 関数**:
    * **アプリケーションファクトリパターン** を採用しています。実行時に `app = create_app()` を呼び出すことでインスタンスを生成します。これにより、テスト用設定での起動などが容易になります。
    * **設定の読み込み**: `.env` ファイルから `SECRET_KEY` などの環境変数を読み込みます。
    * **拡張機能の初期化**: `Flask-Login` (認証), `Flask-WTF` (CSRF保護) などのプラグインを初期化します。
    * **Blueprintの登録**: `routers` フォルダ内で定義された各機能（auth, admin, plan, patient）をアプリケーションに統合します。
    * **ロギング設定**: ログファイル (`logs/gemini_prompts.log`) への出力設定を行います。

### `auth_models.py` (セッション用ユーザーモデル)
Flask-Login がセッション管理に使用する、軽量なユーザーモデル定義です。

* **役割**:
    * `app/models/staff.py` (DBモデル) とは異なり、データベース接続を持ちません。
    * ログイン中のユーザー情報（ID, 名前, ロール）をメモリ上に保持し、`current_user` プロパティを通じてアクセスできるようにします。
* **設計意図**:
    * データベースモデルとセッションモデルを分離することで、セッション管理の軽量化と、循環参照のリスク低減を図っています。

### `constants.py` (定数定義)
アプリケーション全体で使用される固定値を管理します。

* **`ITEM_KEY_TO_JAPANESE`**:
    * データベースのカラム名（例: `main_risks_txt`）を、画面表示用の日本語ラベル（例: `安静度・リスク`）に変換するための辞書です。
    * テンプレート (`view_plan.html`) や AIプロンプト生成時に参照され、表記揺れを防ぎます。

## 🏗 アーキテクチャ概観

このアプリケーションは、**機能分割されたモジュラー構成** を採用しています。


```

app/
├── core/       # DB接続などのインフラ
├── models/     # データ構造定義 (ORM)
├── crud/       # DB操作ロジック
├── services/   # ビジネスロジック (AI, Excel)
├── routers/    # URLルーティング (Controller)
├── schemas/    # Pydanticスキーマ (AI出力定義)
├── utils/      # 共通ヘルパー・デコレータ
└── web/        # フロントエンド (HTML/CSS/JS)

```

`__init__.py` はこれらのモジュールを統括し、リクエストのライフサイクル（受信 → ルーティング → ロジック実行 → レスポンス）を管理します。

## 📝 開発者向けメモ

* **環境変数の追加**: 新しいAPIキーや設定値が必要になった場合は、`.env` ファイルに追加した後、`__init__.py` の `app.config` 設定部分にも反映させてください。
* **新しい機能の追加**: 新しい `routers` モジュールを作成した場合は、必ず `__init__.py` で `app.register_blueprint(...)` を行ってください。これを忘れると、新しいページにアクセスしても 404 エラーになります。
