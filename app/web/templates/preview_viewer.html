<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Preview</title>

    <!-- STABLE 2.1.13 -->
    <!-- <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/luckysheet@2.1.13/dist/plugins/css/pluginsCss.css' />
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/luckysheet@2.1.13/dist/plugins/plugins.css' />
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/luckysheet@2.1.13/dist/css/luckysheet.css' />
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/luckysheet@2.1.13/dist/assets/iconfont/iconfont.css' /> -->
    <link rel="stylesheet" href="{{ url_for('static', filename='lib/luckysheet/pluginsCss.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='lib/luckysheet/plugins.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='lib/luckysheet/luckysheet.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='lib/luckysheet/iconfont.css') }}">

    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #f0f0f0;
        }

        #luckysheet-container {
            margin: 0;
            padding: 0;
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #loading_overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #loading_overlay h2 {
            font-family: sans-serif;
            color: #666;
        }

        /* HIDING UI ELEMENTS FORCEFULLY */
        .luckysheet-wa-editor {
            display: none !important;
        }

        .luckysheet-info-detail-back {
            display: none !important;
        }

        .luckysheet-share-logo {
            display: none !important;
        }
    </style>
</head>

<body>
    <div id="loading_overlay">
        <h2>Loading Preview...</h2>
    </div>

    <div id="luckysheet-container"></div>

    <!-- <script src="https://cdn.jsdelivr.net/npm/luckysheet@2.1.13/dist/plugins/js/plugin.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luckysheet@2.1.13/dist/luckysheet.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luckyexcel/dist/luckyexcel.umd.js"></script> -->
    <script src="{{ url_for('static', filename='lib/luckysheet/plugin.js') }}"></script>
    <script src="{{ url_for('static', filename='lib/luckysheet/luckysheet.umd.js') }}"></script>
    <script src="{{ url_for('static', filename='lib/luckysheet/luckyexcel.umd.js') }}"></script>

    <script>
        const base64Data = "{{ excel_base64 }}";

        function base64ToArrayBuffer(base64) {
            const binary_string = window.atob(base64);
            const len = binary_string.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binary_string.charCodeAt(i);
            }
            return bytes.buffer;
        }

        window.onerror = function (message, source, lineno, colno, error) {
            const overlay = document.querySelector('#loading_overlay h2');
            if (overlay) {
                overlay.innerText = "Error: " + message;
                overlay.style.color = "red";
            }
        };

        window.onload = function () {
            try {
                if (!base64Data) throw new Error("No data received.");
                const data = base64ToArrayBuffer(base64Data);

                LuckyExcel.transformExcelToLucky(data, function (exportJson, luckysheetfile) {

                    // --- DEEP CLEAN RECONSTRUCTION ---
                    const cleanSheets = exportJson.sheets.map(function (sheet) {
                        let cleanCelldata = [];
                        if (sheet.celldata) {
                            cleanCelldata = sheet.celldata.map(function (cell) {
                                if (!cell || !cell.v) return null;
                                let cleanV = {};
                                const safeProps = ['m', 'v', 'bg', 'fc', 'bl', 'it', 'ff', 'fs', 'ht', 'vt', 'ct', 'tb', 'tr', 'rt'];
                                safeProps.forEach(k => { if (cell.v[k] !== undefined) cleanV[k] = cell.v[k]; });

                                // Explicitly REMOVE 'f' (formula)
                                delete cleanV.f;

                                // --- BOOLEAN DISPLAY LOGIC ---
                                // Convert "True"/"False" or true/false to "☑"/"☐"
                                let val = cleanV.v;
                                if (typeof val === 'string') {
                                    if (val.toLowerCase() === 'true') val = true;
                                    else if (val.toLowerCase() === 'false') val = false;
                                }

                                if (val === true) {
                                    cleanV.v = "☑";
                                    cleanV.m = "☑";
                                } else if (val === false) {
                                    cleanV.v = "☐";
                                    cleanV.m = "☐";
                                }
                                // -----------------------------

                                return { r: cell.r, c: cell.c, v: cleanV };
                            }).filter(x => x !== null);
                        }

                        return {
                            name: sheet.name,
                            color: sheet.color,
                            config: sheet.config || {},
                            index: sheet.index,
                            status: sheet.status,
                            order: sheet.order,
                            row: sheet.row || 100,
                            column: sheet.column || 100,
                            celldata: cleanCelldata,
                            calcChain: []
                        };
                    });

                    luckysheet.create({
                        container: 'luckysheet-container',
                        data: cleanSheets,
                        title: exportJson.info.name,
                        lang: 'en', // Keep EN to prevent hang
                        allowEdit: false,
                        forceCalculation: false,
                        showinfobar: false,
                        showsheetbar: true,
                        showstatisticBar: true,
                        showtoolbar: false,
                        sheetFormulaBar: false,
                        enableAddRow: false,
                        enableAddBackTop: false,
                        hook: {
                            workbookCreateAfter: function () {
                                document.getElementById('loading_overlay').style.display = 'none';
                                luckysheet.resize();
                            }
                        }
                    });
                }, function (err) {
                    console.error("Transform Error: " + err);
                    document.querySelector('#loading_overlay h2').innerText = "Transform Error: " + err;
                });
            } catch (e) {
                console.error("Fatal Error: " + e.message);
                document.querySelector('#loading_overlay h2').innerText = "Fatal Error: " + e.message;
            }
        };
    </script>
</body>

</html>