# Frontend Layer (`app/web/`)

このディレクトリは、MVCアーキテクチャにおける **View** に相当し、ユーザーが直接触れるインターフェースを提供します。
Flaskのテンプレートエンジン **Jinja2** を使用したHTML生成と、**JavaScript** による動的なUI操作を組み合わせています。

## 📁 ディレクトリ構成と役割

### `templates/` (HTMLテンプレート)
画面の構造を定義するHTMLファイル群です。Jinja2記法を用いて、サーバー（Router/Controller）から渡された変数を埋め込みます。

* **認証関連**:
    * `login.html`: ログイン画面。
    * `signup.html`: 職員登録画面。
* **患者管理**:
    * `index.html`: トップページ兼患者一覧ダッシュボード。担当患者の絞り込み表示などを行います。
    * `edit_patient_info.html`: 患者情報の登録・編集フォーム。FIM/BIの推移グラフもここに表示されます。
* **計画書作成フロー**:
    * `view_plan.html`: **計画書作成のメイン画面**。左側にAI生成結果、右側に編集フォームを配置した2カラム構成など、複雑なUIを持ちます。
    * `confirm.html`: 最終確認画面。入力内容を一覧表示します。
    * `download_and_redirect.html`: Excel生成完了後のダウンロード処理と、画面遷移を制御するクッションページ。
* **管理者用**:
    * `manage_assignments.html`: 職員と患者の担当割り当てをドラッグ＆ドロップ等で管理する画面。
* **コンポーネント (`components/`)**:
    * `patient_info_ref.html` など、複数の画面で再利用される部品（パーシャルテンプレート）。

### `static/` (静的アセット)
CSS、JavaScript、画像、およびサードパーティ製のライブラリを配置しています。

* **`style.css`**: アプリケーション全体のデザイン定義。
* **`lib/`**: オフライン環境でも動作するように、外部ライブラリをローカルに保持しています。
    * **Bootstrap 5**: レスポンシブデザインとUIコンポーネント（モーダル、カード等）。
    * **Chart.js**: 患者のADL（日常生活動作）スコアの推移を折れ線グラフで描画。
    * **Luckysheet**: **ExcelライクなスプレッドシートUI** をブラウザ上で実現。計画書のプレビューや高度な編集に使用。
    * **Mermaid.js**: フローチャートやダイアグラムの描画。
    * **Marked.js**: MarkdownテキストをHTMLに変換（AIの出力を整形表示するために使用）。

## 🏗 設計思想と実装ロジック

### 1. ハイブリッドなレンダリング戦略
基本はFlaskによる **サーバーサイドレンダリング (SSR)** ですが、ユーザー体験 (UX) を向上させるために、部分的に **クライアントサイドレンダリング (CSR)** を取り入れています。

* **SSRの領域**: ページの初期表示、認証状態による表示切り替え、マスターデータの展開。
* **CSRの領域**:
    * **AI生成テキストのストリーミング**: `fetch` API と `Server-Sent Events` を使い、AIが生成するテキストをリアルタイムに画面に追記します。
    * **動的なグラフ描画**: `Chart.js` を使い、FIM/BIのスコアデータを視覚化します。

### 2. LuckysheetによるExcel体験の再現
リハビリ計画書は表形式の複雑なドキュメントです。
単なるHTMLテーブルではなく、**Luckysheet** ライブラリを導入することで、ブラウザ上でExcelに近い操作感（セル結合、列幅調整など）を提供し、完成イメージを直感的に確認できるようにしています。

### 3. レスポンシブデザイン
`Bootstrap` をベースに構築しており、デスクトップPC（カルテ端末）だけでなく、タブレット端末（回診時の参照）でも閲覧しやすいレイアウトを採用しています。

## 🔗 依存関係

* **⬅️ Rendered by `app/routers/`**: コントローラーからテンプレート名と変数が渡され、レンダリングされます。
* **➡️ Calls `app/routers/plan/api.py`**: 画面内のJavaScriptから非同期APIを呼び出し、AI生成やデータの保存を行います。
* **➡️ Uses `app/services/excel/`**: ダウンロード機能において、バックエンドで生成されたExcelファイルを受け取ります。

## 📝 開発者向けメモ

* **JavaScriptの修正**: 画面の挙動（ボタンクリック時の動作など）を変更する場合は、各HTMLファイル内の `<script>` タグ、または `static/js/` (もしあれば) を確認してください。特に `view_plan.html` にはAIストリーミング受信の重要なロジックが含まれています。
* **キャッシュのクリア**: CSSやJSを変更しても反映されない場合は、ブラウザのキャッシュが効いている可能性があります。開発中はブラウザの「キャッシュ無効化」オプションを使用するか、スーパーリロード (Ctrl+F5) を行ってください。